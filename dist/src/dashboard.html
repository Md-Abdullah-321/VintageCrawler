<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Classic Car Scraper Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 min-h-screen font-sans text-gray-900">
    <div class="container mx-auto px-4 py-10">
      <!-- Dashboard Header -->
      <header class="mb-12 text-center">
        <h1 class="text-4xl font-bold leading-tight">
          Classic Car Scraper Dashboard
        </h1>
        <p class="text-gray-600 mt-2 text-lg">
          Start scraping classic car listings and download CSVs easily
        </p>
      </header>

      <!-- Start Scraping Form -->
      <section
        class="bg-white shadow-lg rounded-2xl p-6 md:p-8 mb-12 max-w-4xl mx-auto"
      >
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">
          Start New Scraping Job
        </h2>

        <form
          id="scrape-form"
          class="space-y-6"
          aria-label="Start scraping job form"
        >
          <!-- Scraping Method Selection -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Scraping Method
            </label>
            <div class="flex space-x-4">
              <label class="inline-flex items-center">
                <input
                  type="radio"
                  name="scrape_method"
                  value="make_model"
                  checked
                  class="form-radio h-5 w-5 text-blue-600 focus:ring-blue-500"
                />
                <span class="ml-2 text-gray-700">Make and Model</span>
              </label>
              <label class="inline-flex items-center">
                <input
                  type="radio"
                  name="scrape_method"
                  value="url"
                  class="form-radio h-5 w-5 text-blue-600 focus:ring-blue-500"
                />
                <span class="ml-2 text-gray-700">URL</span>
              </label>
            </div>
          </div>

          <!-- Make/Model Fields -->
          <div
            id="make-model-fields"
            class="grid grid-cols-1 sm:grid-cols-2 gap-6"
          >
            <div>
              <label for="car_make" class="block text-sm font-medium text-gray-700 mb-2">
                Car Make
              </label>
              <input
                type="text"
                id="car_make"
                placeholder="e.g., Ford"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
              />
            </div>
            <div>
              <label for="car_model" class="block text-sm font-medium text-gray-700 mb-2">
                Car Model
              </label>
              <input
                type="text"
                id="car_model"
                placeholder="e.g., Mustang"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
              />
            </div>
            <div>
              <label for="transmission" class="block text-sm font-medium text-gray-700 mb-2">
                Transmission
              </label>
              <select
                id="transmission"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
              >
                <option value="">Select Transmission</option>
                <option value="Manual">Manual</option>
                <option value="Automatic">Automatic</option>
              </select>
            </div>
            <div>
              <label for="site" class="block text-sm font-medium text-gray-700 mb-2">
                Select Site
              </label>
              <select
                id="site"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
              >
                <option value="">Select Site</option>
                <option value="theclassicvaluer.com">The Classic Valuer</option>
                <option value="classic.com">classic.com</option>
                <option value="both">Both</option>
              </select>
            </div>
          </div>

          <!-- URL Field -->
          <div id="url-field" class="hidden">
            <label for="scrape_url" class="block text-sm font-medium text-gray-700 mb-2">
              URL
            </label>
            <input
              type="url"
              id="scrape_url"
              placeholder="e.g., https://example.com/car-listing"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
            />
          </div>

          <div
            id="options-section"
            class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
          >
            <label id="keep-duplicates-label" class="inline-flex items-center" for="keep_duplicates">
              <input
                type="checkbox"
                id="keep_duplicates"
                class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-400"
              />
              <span class="ml-2 text-gray-700 font-medium">Keep Duplicates</span>
            </label>
            <label class="inline-flex items-center" for="debug_mode">
              <input
                type="checkbox"
                id="debug_mode"
                class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-400"
              />
              <span class="ml-2 text-gray-700 font-medium">Debug Mode</span>
            </label>
          </div>

          <div class="text-center">
            <button
              type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-8 py-3 rounded-xl shadow-md transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 w-full sm:w-auto"
            >
              Start Scraping
            </button>
          </div>
        </form>
      </section>

      <!-- Scraping Jobs -->
      <section class="mb-12 max-w-4xl mx-auto">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
          <h2 class="text-2xl font-semibold text-gray-800">Scraping Jobs</h2>
          <div class="flex gap-3">
            <button id="refresh-jobs" class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded-xl shadow-sm">
              Refresh
            </button>
            <button id="clear-storage" class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-xl shadow-sm">
              Clear Storage
            </button>
          </div>
        </div>
        <div id="job-list" class="bg-white shadow-md rounded-2xl p-8 space-y-4">
          <p class="text-center text-gray-600">No scraping jobs yet.</p>
        </div>
      </section>

      <!-- Available CSVs -->
      <section class="mb-12 max-w-4xl mx-auto">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
          <h2 class="text-2xl font-semibold text-gray-800">Available CSVs</h2>
          <button id="refresh-csvs" class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded-xl shadow-sm">
            Refresh
          </button>
        </div>
        <ul id="csv-list" class="bg-white shadow-md rounded-2xl p-8 space-y-4">
          <li class="text-center text-gray-500">No CSVs available yet.</li>
        </ul>
      </section>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("scrape-form");
        const makeInput = document.getElementById("car_make");
        const modelInput = document.getElementById("car_model");
        const siteSelect = document.getElementById("site");
        const urlInput = document.getElementById("scrape_url");
        const makeModelFields = document.getElementById("make-model-fields");
        const urlField = document.getElementById("url-field");
        const keepDuplicatesLabel = document.getElementById("keep-duplicates-label");
        const scrapeMethodRadios = document.querySelectorAll("input[name='scrape_method']");
        const jobList = document.getElementById("job-list");
        let currentJobId = null;
        let lastFileCount = 0;

        function toggleFormFields() {
          const method = document.querySelector("input[name='scrape_method']:checked").value;
          if (method === "url") {
            makeModelFields.classList.add("hidden");
            urlField.classList.remove("hidden");
            keepDuplicatesLabel.classList.add("hidden");
          } else {
            makeModelFields.classList.remove("hidden");
            urlField.classList.add("hidden");
            keepDuplicatesLabel.classList.remove("hidden");
          }
        }
        toggleFormFields();
        scrapeMethodRadios.forEach(r => r.addEventListener("change", toggleFormFields));

        const loadJobs = () => {
          const jobs = JSON.parse(localStorage.getItem("scrapingJobs") || "[]");
          renderJobs(jobs);
        };

        const saveJob = (job) => {
          const jobs = JSON.parse(localStorage.getItem("scrapingJobs") || "[]");
          jobs.push(job);
          localStorage.setItem("scrapingJobs", JSON.stringify(jobs));
          renderJobs(jobs);
        };

        const renderJobs = (jobs) => {
          jobs.sort((a, b) => new Date(b.startedAt) - new Date(a.startedAt));
          jobList.innerHTML = jobs.length
            ? jobs.map(job => `
              <div class="flex flex-col p-4 border border-gray-200 rounded-lg">
                <div class="flex justify-between">
                  <span>${job.url || `${job.make} ${job.model}`}</span>
                  <span>${new Date(job.startedAt).toLocaleString()}</span>
                </div>
                <div class="mt-2 flex justify-between items-center">
                  <p class="text-sm text-gray-600 font-medium">${job.status.toUpperCase()} - ${job.progress}%</p>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                  <div class="h-2.5 rounded-full" 
                       style="width:${job.progress}%; background-color:${job.status === 'failed' ? '#ef4444' : '#3b82f6'}">
                  </div>
                </div>
                <p class="text-sm text-gray-500 mt-1">${getStatusMessage(job)}</p>
              </div>
            `).join("")
            : "<p class='text-center text-gray-600'>No scraping jobs yet.</p>";
        };

        const getStatusMessage = (job) => {
          switch (job.status) {
            case "in progress":
              if (job.progress <= 10) return "Initializing scraping job...";
              if (job.progress <= 50) return "Navigating sites and validating results...";
              if (job.progress < 100) return "Saving results to CSV...";
              return "Almost done...";
            case "completed":
              return "Job completed successfully!";
            case "failed":
              return "Job failed. Check logs for details.";
            default:
              return "Waiting...";
          }
        };

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const method = document.querySelector("input[name='scrape_method']:checked").value;
          [makeInput, modelInput, siteSelect, urlInput].forEach(el => el.classList.remove("border-red-500"));
          let hasError = false;
          if (method === "make_model") {
            if (!makeInput.value.trim()) { makeInput.classList.add("border-red-500"); hasError = true; }
            if (!modelInput.value.trim()) { modelInput.classList.add("border-red-500"); hasError = true; }
            if (!siteSelect.value.trim()) { siteSelect.classList.add("border-red-500"); hasError = true; }
          } else {
            if (!urlInput.value.trim()) { urlInput.classList.add("border-red-500"); hasError = true; }
          }
          if (hasError) return;

          const payload = method === "make_model"
            ? { method, make: makeInput.value.trim(), model: modelInput.value.trim(), transmission: document.getElementById("transmission").value, site: siteSelect.value, keep_duplicates: document.getElementById("keep_duplicates").checked, debug_mode: document.getElementById("debug_mode").checked }
            : { method, url: urlInput.value.trim(), keep_duplicates: false, debug_mode: document.getElementById("debug_mode").checked };

          try {
            alert("ðŸš€ Starting scraping job...");
            const res = await fetch("/api/v1/scrape", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
            const data = await res.json();
            if (!res.ok) { alert(`âŒ Failed: ${data.message || "Unknown error"}`); return; }
            currentJobId = data.payload.jobId;
            saveJob({ ...payload, jobId: currentJobId, status: "in progress", progress: 10, startedAt: new Date().toISOString() });
            monitorJobProgress(currentJobId);
          } catch (err) {
            console.error(err);
            alert("âŒ Request failed. Check console.");
          }
        });

        const monitorJobProgress = (jobId) => {
          const interval = setInterval(async () => {
            try {
              const res = await fetch(`/api/v1/scrape/status/${jobId}`);
              const job = await res.json();
              const jobs = JSON.parse(localStorage.getItem("scrapingJobs") || "[]");
              const updated = jobs.map(j => j.jobId === jobId ? { ...j, ...job } : j);
              localStorage.setItem("scrapingJobs", JSON.stringify(updated));
              renderJobs(updated);
              if (job.status === "completed" || job.status === "failed") {
                clearInterval(interval);
                loadCSVs();
              }
            } catch (err) {
              clearInterval(interval);
              console.error(err);
            }
          }, 1000);
        };

        async function loadCSVs() {
          const list = document.getElementById("csv-list");
          list.innerHTML = "<li class='text-center'>Loading CSVs...</li>";
          try {
            const res = await fetch("/api/v1/csv");
            const files = await res.json();
            list.innerHTML = "";
            if (!files.length) {
              list.innerHTML = "<li class='text-center text-gray-500'>No CSVs available yet.</li>";
              lastFileCount = 0;
              return;
            }
            lastFileCount = files.length;
            files.forEach(file => {
              const li = document.createElement("li");
              li.className = "flex items-center justify-between bg-gray-50 px-4 py-3 rounded-lg border border-gray-200";
              const formattedDate = file.startedAt ? new Date(file.startedAt).toLocaleString() : "Unknown";
              li.innerHTML = `
                <div class="flex flex-col">
                  <span class="font-medium">${file.fileName}</span>
                  <span class="text-sm text-gray-600">Scraped: ${formattedDate}</span>
                </div>
                <a href="/download/${file.fileName}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">Download</a>
              `;
              list.appendChild(li);
            });
          } catch (err) {
            console.error(err);
            list.innerHTML = "<li class='text-center text-red-500'>Failed to load CSVs.</li>";
          }
        }

        function startPolling() {
          setInterval(async () => {
            try {
              const res = await fetch("/api/v1/csv");
              const files = await res.json();
              if (files.length !== lastFileCount) loadCSVs();
            } catch (err) {
              console.error(err);
            }
          }, 10000);
        }

        document.getElementById("refresh-jobs").addEventListener("click", loadJobs);
        document.getElementById("refresh-csvs").addEventListener("click", loadCSVs);
        document.getElementById("clear-storage").addEventListener("click", () => {
          localStorage.removeItem("scrapingJobs");
          loadJobs();
          alert("Local storage cleared.");
        });

        loadJobs();
        loadCSVs();
        startPolling();
      });
    </script>
  </body>
</html>